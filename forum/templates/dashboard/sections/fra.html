{% extends "dashboard/section.html" %}
{% set title = 'Forum Rhône-Alpes' %}
{% set events = get_master_class() %}
{% block content %}
  <div class="row">
    <div class="col-xs-12">
      <div class="box">
        <!-- /.box-header -->
        <div class="box-body table-responsive no-padding">
          {% if user.events.fra.registered %}
            <tr>
              <td colspan="4">
                <h2 class="lead text-center">Ton inscription au Forum Rhône-Alpes est bien prise en compte.
                </h2>
                {% set companies = current_user.id | to_ambassador %}
                {% if companies %}
                  {% for k, v in companies.items() %}
                    {{ '<h4 class="lead text-center">Tu seras ambassadeur de'|safe if loop.first else '' }}
                    <strong>{{v|to_name}}
                      ({{k|capitalize}})</strong>
                    {{ 'et' if not loop.last else '.' }}
                  {% endfor %}
                  {{ '</h4>'|safe if loop.last else '' }}
                {% endif %}
              </td>
            </tr>
          {% else %}
            <tr>
              <td colspan="4">
                <h2 class="lead text-center">Tu n'es pas encore inscrit à cet évènement :(</h2>
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
    <!-- /.box-body -->
  </div>
  <!-- /.box -->
</div>
</div>
{% if not user.events.fra.registered %}
<div class="row no-print">
  <div class="col-md-12">
    <div class="box">
      <div class="box-header">
        <h3 class="box-title">
          Inscrits-toi au Forum Rhône-Alpes
        </h3>
        <div class="box-tools pull-right">
          <button type="button" class="btn btn-box-tool" data-widget="collapse">
            <i class="fa fa-minus"></i>
          </button>
        </div>
      </div>
      <!-- /.box-header -->
      <div class="box-body">
        <div class="row">
          <div class="col-md-12">
            <div class="form-group">
              <div class="radio">
                <label>
                  <input type="checkbox" name="fra">
                  Je souhaite m'inscrire à l'évènement Forum Rhône-Alpes.
                </label>
              </div>
            </div>
          </div>
        </div>
        <div class="box-footer">
          <button id="confirm_fra" type="submit" class="btn btn-primary">Confirmer</button>
        </div>
        <!-- /.box-body -->
      </div>
      <!-- /.box-body -->
    </div>
    <!-- /.box -->
  </div>
</div>
{% else %}
<div class="row">
  <div class="col-md-12 no-print">
    <div class="box">
      <div class="box-header">
        <h3 class="box-title">
          Deviens un ambassadeur
        </h3>
        <div class="box-tools pull-right">
          <button type="button" class="btn btn-box-tool" data-widget="collapse">
            <i class="fa fa-minus"></i>
          </button>
        </div>
      </div>
      <!-- /.box-header -->
      <div class="box-body">
        <p class="lead">En consultant la liste des entreprises, tu peux devenir ambassadeur d'une entreprise. Tu auras ainsi l'occasion de côtoyer durant une journée les RH et opérationnels de l'entreprise de ton choix: un bon moyen de te faire remarquer !
        </p>
        <form id="confirm_ambassador">
          <div class="box-body">
            <div class="row r-center">
              {% for day in['mercredi',
                'jeudi'] %}
                <div class="col-md-6">
                  <div class="form-group">
                    <label>choisis une entreprise à parrainer pour
                      {{ day }}</label>
                    <select class="form-control select2 company_{{loop.index}}" style="width: 100%;">
                      {% set companies = day | to_companies %}
                      <option value="none">Aucune</option>
                      {% for c in companies %}
                        <option value="{{c.id}}" {{ 'disabled' if c.is_filled else ''}}>{{c.name}}
                          {{ '(complet)' if c.is_filled else '' }}</option>
                      {% endfor %}
                    </select>
                  </div>
                </div>
              {% endfor %}
              <!-- /.input group -->
            </div>
          </div>
          <div class="box-footer">
            <button type="submit" class="btn btn-primary">Confirmer</button>
          </div>
        </form>
        <!-- /.input group -->
      </div>
      <!-- /.box-body -->
    </div>
    <!-- /.box-body -->
  </div>
  <div class="col-md-12">
    <div class="box">
      <div class="box-header">
        <h3 class="box-title">
          Ton billet
        </h3>
        <div class="box-tools pull-right">
          <button type="button" class="btn btn-box-tool" data-widget="collapse">
            <i class="fa fa-minus"></i>
          </button>
        </div>
      </div>
      <!-- /.box-header -->
      <div class="box-body">
        <div class="row">
          <div class="col-md-5" style="padding:30px">
            {% set code = dict(id = current_user.id, registered = current_user.events.fra.registered) %}
            {% set code = '%s,%s' | format(code.id, code.registered) %}
            <img src="{{ qrcode(data=code, fill_color='#222d32', error_correction='H', icon_img='images/logo.png', factor=2) }}">
          </div>
          <div class="col-md-1"></div>
          <div class="col-md-5 no-print" style="padding:30px ">
            <h3>1ère étape</h3>
            <p>
              <a href="javascript:window.print()" target="_blank" class="btn btn-default">
                <i class="fa fa-print"></i>
                Imprime ton billet</a>
              ou sauvegarde cette page sur ton smartphone.</p>
            <h3>2ème étape</h3>
            <p>Présente ton billet à l'accueil pour accéder au salon.</p>
            <h3>3ème étape</h3>
            <p>Profite du Forum Rhône-Alpes ;) !</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}
{% endblock content %}
{% block scripts %}
<script type="text/javascript">
$(".select2").select2({language: "fr"});
function update_fra() {
  $.ajax({
    type: "POST",
    data: {
      'event': 'fra'
    },
    url: "{{ url_for('update_event') }}",
    success: function (result) {
      if (result == 'success') {
        Notify("Changements sauvegardés.");
        setTimeout(function () {
          location.reload();
        }, 1000);
      } else {
        Notify("Veuillez remplir votre profil avant de vous inscrire.", null, null, "warning");
      }
    }
  });
  return false;
}
$('#confirm_fra').on('click', function (e) {
  e.preventDefault();
  update_fra();
});
$('#confirm_ambassador').on('submit', function (e) {
  e.preventDefault();
  var first = $('.company_1').val();
  var second = $('.company_2').val();
  $.ajax({
    type: "POST",
    data: {
      'first': first,
      'second': second
    },
    url: "{{ url_for('update_ambassador') }}",
    success: function (result) {
      if (result == 'success') {
        Notify("Changements sauvegardés.");
        setTimeout(function () {
          location.reload();
        }, 1000);
      } else {
        Notify("Une erreur est survenue. Réessayez.", null, null, "error");
      }
    }
  });
  return false;
});
</script>
{% endblock scripts %}
